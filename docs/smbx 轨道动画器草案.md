# SMBX 轨道动画器草案

## 数值

SMBX 的整数 (Integer) 为 16 位, 以及其字符串使用 utf-16 作为编码方式. 这里我们也使用 16 位作为序列器数值的位数.

在这 16 位数中, 高两位标识数据类型, 剩下的低 14 位标识数据内容, 例如, 观察这个数字: [**11**00-0010-0101-0010], 加粗的 ‘**11**’ 为数据类型, 其后的 ‘00-0010-0101-0010’ 为该数字的内容.

- 合法数值 (整数) (类型为 **00**): **[-1600, 14783]** (原始数据取值区间为 [0, 16383] [***0b***0, ***0b***0000-1111-1111-1111]; 计算最终值为原始值 -1600, 所以最终输出的数据取值区间为 [-1600, 14783], 至于为何要如此规划该数值, 是因为 1600 刚好跨两个屏幕宽度 (一屏宽度大概 800), 实践上坐标左右跨两屏应该够用)
- 合法数值 (小数) (类型为 **01**): (0, 1] 小数点后的内容, 其分母取值范围为: [1,16383] (表现在二进制上则是 [***0b***0, ***0b***0111-1111-1111-1111] + 1, 此处高第二位为 1, 表达该数为小数, 不参与数值运算)
- 特殊值 (当前值) (类型为 **10**, 值为 00-0000-0000-0001): **-32767** (取到该值时意为保持当前轨道值不变, 在二进制位上, 表现为高第三位以及最低位为 1: ***0b***1000-0000-0000-0001)
- 特殊值 (NaN) (类型为 **10**, 值为 0): **-32768** (***0b***1000-0000-0000-0000)

- **关键帧设置** (类型为 **11**) (这个为特殊类型, 用来作为关键帧标识): ***0b*** 11-[首两位为插值方式: 0~3 分别代表常量/线性/三角/三次]-[后 12 位代表帧位, 1~4096, 这意味着如果以 60 帧/秒来计算, 一个动画序列最多只能支持保存 68s 的动画]

## 轨道数据结构

- 头部 (6 个整数(16 bit)):

  1. 序列总帧数长度 (0~4095)
  2. 帧率 (默认为 60)
  3. 关键帧数量
  4. 值乘数
  5. 值内加数
  6. 值外加数

  **轨道输出值**为 ((value + 值内加数) * 值乘数) + 值外加数, 其中 value 为当前帧轨道的计算最终值

- 正文 (假设该轨道有 k 个关键帧, 则有 k*2 个整数):

  1. 关键帧设置
  2. 关键帧值

## 轨道应用相关接口

- `export script Track_GetValue(idx as integer, t as double)` 返回值为**轨道输出值**. 其中, idx 为轨道索引, 具体含义参见轨道映射表; t 表示动画时间, 若 t <= 1, 则表示使用归一化坐标, 若 t > 1, 则表示使用帧号。

## 轨道映射表

- 一组轨道：轨道数 Q |轨道起始点 q_1 … 轨道起始点 q_Q|轨道正文…

